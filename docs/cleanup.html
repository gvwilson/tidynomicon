<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Chapter 6 Cleaning Up Data | The Tidynomicon</title>
  <meta name="description" content="Chapter 6 Cleaning Up Data | The Tidynomicon">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="Chapter 6 Cleaning Up Data | The Tidynomicon" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Chapter 6 Cleaning Up Data | The Tidynomicon" />
  <meta name="github-repo" content="gvwilson/tidynomicon" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Cleaning Up Data | The Tidynomicon" />
  
  <meta name="twitter:description" content="Chapter 6 Cleaning Up Data | The Tidynomicon" />
  

<meta name="author" content="Greg Wilson">


<meta name="date" content="2019-05-08">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="tidyverse.html">
<link rel="next" href="testerror.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The Tidynomicon</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#s:index-personas"><i class="fa fa-check"></i><b>1.1</b> Who are these lessons for?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Values and Vectors</a><ul>
<li class="chapter" data-level="2.1" data-path="basics.html"><a href="basics.html#questions"><i class="fa fa-check"></i><b>2.1</b> Questions</a></li>
<li class="chapter" data-level="2.2" data-path="basics.html"><a href="basics.html#learning-objectives"><i class="fa fa-check"></i><b>2.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="2.3" data-path="basics.html"><a href="basics.html#how-do-i-say-hello"><i class="fa fa-check"></i><b>2.3</b> How do I say hello?</a></li>
<li class="chapter" data-level="2.4" data-path="basics.html"><a href="basics.html#how-do-i-add-numbers"><i class="fa fa-check"></i><b>2.4</b> How do I add numbers?</a></li>
<li class="chapter" data-level="2.5" data-path="basics.html"><a href="basics.html#how-do-i-store-many-numbers-together"><i class="fa fa-check"></i><b>2.5</b> How do I store many numbers together?</a></li>
<li class="chapter" data-level="2.6" data-path="basics.html"><a href="basics.html#how-do-i-index-a-vector"><i class="fa fa-check"></i><b>2.6</b> How do I index a vector?</a></li>
<li class="chapter" data-level="2.7" data-path="basics.html"><a href="basics.html#how-do-i-create-new-vectors-from-old"><i class="fa fa-check"></i><b>2.7</b> How do I create new vectors from old?</a></li>
<li class="chapter" data-level="2.8" data-path="basics.html"><a href="basics.html#how-else-does-r-represent-the-absence-of-data"><i class="fa fa-check"></i><b>2.8</b> How else does R represent the absence of data?</a></li>
<li class="chapter" data-level="2.9" data-path="basics.html"><a href="basics.html#key-points"><i class="fa fa-check"></i><b>2.9</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="indexing.html"><a href="indexing.html"><i class="fa fa-check"></i><b>3</b> Indexing</a><ul>
<li class="chapter" data-level="3.1" data-path="indexing.html"><a href="indexing.html#questions-1"><i class="fa fa-check"></i><b>3.1</b> Questions</a></li>
<li class="chapter" data-level="3.2" data-path="indexing.html"><a href="indexing.html#learning-objectives-1"><i class="fa fa-check"></i><b>3.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="3.3" data-path="indexing.html"><a href="indexing.html#how-can-i-store-a-mix-of-different-types-of-objects"><i class="fa fa-check"></i><b>3.3</b> How can I store a mix of different types of objects?</a></li>
<li class="chapter" data-level="3.4" data-path="indexing.html"><a href="indexing.html#what-is-the-difference-between-and"><i class="fa fa-check"></i><b>3.4</b> What is the difference between <code>[</code> and <code>[[</code>?</a></li>
<li class="chapter" data-level="3.5" data-path="indexing.html"><a href="indexing.html#how-can-i-access-elements-by-name"><i class="fa fa-check"></i><b>3.5</b> How can I access elements by name?</a></li>
<li class="chapter" data-level="3.6" data-path="indexing.html"><a href="indexing.html#how-can-i-create-and-index-a-matrix"><i class="fa fa-check"></i><b>3.6</b> How can I create and index a matrix?</a></li>
<li class="chapter" data-level="3.7" data-path="indexing.html"><a href="indexing.html#key-points-1"><i class="fa fa-check"></i><b>3.7</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="control.html"><a href="control.html"><i class="fa fa-check"></i><b>4</b> Control Flow</a><ul>
<li class="chapter" data-level="4.1" data-path="control.html"><a href="control.html#questions-2"><i class="fa fa-check"></i><b>4.1</b> Questions</a></li>
<li class="chapter" data-level="4.2" data-path="control.html"><a href="control.html#learning-objectives-2"><i class="fa fa-check"></i><b>4.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="4.3" data-path="control.html"><a href="control.html#how-do-i-choose-and-repeat-things"><i class="fa fa-check"></i><b>4.3</b> How do I choose and repeat things?</a></li>
<li class="chapter" data-level="4.4" data-path="control.html"><a href="control.html#how-can-i-express-a-range-of-values-in-r"><i class="fa fa-check"></i><b>4.4</b> How can I express a range of values in R?</a></li>
<li class="chapter" data-level="4.5" data-path="control.html"><a href="control.html#how-can-i-use-a-vector-in-a-conditional-statement"><i class="fa fa-check"></i><b>4.5</b> How can I use a vector in a conditional statement?</a></li>
<li class="chapter" data-level="4.6" data-path="control.html"><a href="control.html#how-do-i-create-and-call-functions"><i class="fa fa-check"></i><b>4.6</b> How do I create and call functions?</a></li>
<li class="chapter" data-level="4.7" data-path="control.html"><a href="control.html#how-can-i-write-a-function-that-takes-a-varying-number-of-arguments"><i class="fa fa-check"></i><b>4.7</b> How can I write a function that takes a varying number of arguments?</a></li>
<li class="chapter" data-level="4.8" data-path="control.html"><a href="control.html#how-can-i-provide-default-values-for-arguments"><i class="fa fa-check"></i><b>4.8</b> How can I provide default values for arguments?</a></li>
<li class="chapter" data-level="4.9" data-path="control.html"><a href="control.html#how-can-i-hide-the-value-that-r-returns"><i class="fa fa-check"></i><b>4.9</b> How can I hide the value that R returns?</a></li>
<li class="chapter" data-level="4.10" data-path="control.html"><a href="control.html#how-can-i-assign-to-a-global-variable-from-inside-a-function"><i class="fa fa-check"></i><b>4.10</b> How can I assign to a global variable from inside a function?</a></li>
<li class="chapter" data-level="4.11" data-path="control.html"><a href="control.html#key-points-2"><i class="fa fa-check"></i><b>4.11</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="tidyverse.html"><a href="tidyverse.html"><i class="fa fa-check"></i><b>5</b> The Tidyverse</a><ul>
<li class="chapter" data-level="5.1" data-path="tidyverse.html"><a href="tidyverse.html#questions-3"><i class="fa fa-check"></i><b>5.1</b> Questions</a></li>
<li class="chapter" data-level="5.2" data-path="tidyverse.html"><a href="tidyverse.html#learning-objectives-3"><i class="fa fa-check"></i><b>5.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.3" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-read-data"><i class="fa fa-check"></i><b>5.3</b> How do I read data?</a></li>
<li class="chapter" data-level="5.4" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-inspect-data"><i class="fa fa-check"></i><b>5.4</b> How do I inspect data?</a></li>
<li class="chapter" data-level="5.5" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-index-rows-and-columns"><i class="fa fa-check"></i><b>5.5</b> How do I index rows and columns?</a></li>
<li class="chapter" data-level="5.6" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-calculate-basic-statistics"><i class="fa fa-check"></i><b>5.6</b> How do I calculate basic statistics?</a></li>
<li class="chapter" data-level="5.7" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-filter-data"><i class="fa fa-check"></i><b>5.7</b> How do I filter data?</a></li>
<li class="chapter" data-level="5.8" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-write-tidy-code"><i class="fa fa-check"></i><b>5.8</b> How do I write tidy code?</a></li>
<li class="chapter" data-level="5.9" data-path="tidyverse.html"><a href="tidyverse.html#modeling"><i class="fa fa-check"></i><b>5.9</b> Modeling</a></li>
<li class="chapter" data-level="5.10" data-path="tidyverse.html"><a href="tidyverse.html#plotting"><i class="fa fa-check"></i><b>5.10</b> Plotting</a></li>
<li class="chapter" data-level="5.11" data-path="tidyverse.html"><a href="tidyverse.html#key-points-3"><i class="fa fa-check"></i><b>5.11</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="cleanup.html"><a href="cleanup.html"><i class="fa fa-check"></i><b>6</b> Cleaning Up Data</a><ul>
<li class="chapter" data-level="6.1" data-path="cleanup.html"><a href="cleanup.html#questions-4"><i class="fa fa-check"></i><b>6.1</b> Questions</a></li>
<li class="chapter" data-level="6.2" data-path="cleanup.html"><a href="cleanup.html#learning-objectives-4"><i class="fa fa-check"></i><b>6.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.3" data-path="cleanup.html"><a href="cleanup.html#how-do-i-inspect-the-raw-data"><i class="fa fa-check"></i><b>6.3</b> How do I inspect the raw data?</a></li>
<li class="chapter" data-level="6.4" data-path="cleanup.html"><a href="cleanup.html#how-do-i-tidy-the-data"><i class="fa fa-check"></i><b>6.4</b> How do I tidy the data?</a></li>
<li class="chapter" data-level="6.5" data-path="cleanup.html"><a href="cleanup.html#key-points-4"><i class="fa fa-check"></i><b>6.5</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="testerror.html"><a href="testerror.html"><i class="fa fa-check"></i><b>7</b> Testing and Error Handling</a><ul>
<li class="chapter" data-level="7.1" data-path="testerror.html"><a href="testerror.html#questions-5"><i class="fa fa-check"></i><b>7.1</b> Questions</a></li>
<li class="chapter" data-level="7.2" data-path="testerror.html"><a href="testerror.html#learning-objectives-5"><i class="fa fa-check"></i><b>7.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="7.3" data-path="testerror.html"><a href="testerror.html#how-does-r-handle-errors"><i class="fa fa-check"></i><b>7.3</b> How does R handle errors?</a></li>
<li class="chapter" data-level="7.4" data-path="testerror.html"><a href="testerror.html#what-should-i-know-about-testing-in-general"><i class="fa fa-check"></i><b>7.4</b> What should I know about testing in general?</a></li>
<li class="chapter" data-level="7.5" data-path="testerror.html"><a href="testerror.html#how-should-i-organize-my-tests"><i class="fa fa-check"></i><b>7.5</b> How should I organize my tests?</a></li>
<li class="chapter" data-level="7.6" data-path="testerror.html"><a href="testerror.html#how-can-i-write-a-few-simple-tests"><i class="fa fa-check"></i><b>7.6</b> How can I write a few simple tests?</a></li>
<li class="chapter" data-level="7.7" data-path="testerror.html"><a href="testerror.html#how-can-i-check-data-transformation"><i class="fa fa-check"></i><b>7.7</b> How can I check data transformation?</a><ul>
<li class="chapter" data-level="7.7.1" data-path="testerror.html"><a href="testerror.html#how-can-i-reorganize-code-to-make-it-more-testable"><i class="fa fa-check"></i><b>7.7.1</b> How can I reorganize code to make it more testable?</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="testerror.html"><a href="testerror.html#key-points-5"><i class="fa fa-check"></i><b>7.8</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="nse.html"><a href="nse.html"><i class="fa fa-check"></i><b>8</b> Non-Standard Evaluation</a><ul>
<li class="chapter" data-level="8.1" data-path="nse.html"><a href="nse.html#questions-6"><i class="fa fa-check"></i><b>8.1</b> Questions</a></li>
<li class="chapter" data-level="8.2" data-path="nse.html"><a href="nse.html#learning-objectives-6"><i class="fa fa-check"></i><b>8.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="8.3" data-path="nse.html"><a href="nse.html#how-does-python-evaluate-function-calls"><i class="fa fa-check"></i><b>8.3</b> How does Python evaluate function calls?</a></li>
<li class="chapter" data-level="8.4" data-path="nse.html"><a href="nse.html#how-does-r-evaluate-the-same-kind-of-thing"><i class="fa fa-check"></i><b>8.4</b> How does R evaluate the same kind of thing?</a></li>
<li class="chapter" data-level="8.5" data-path="nse.html"><a href="nse.html#why-is-lazy-evaluation-useful"><i class="fa fa-check"></i><b>8.5</b> Why is lazy evaluation useful?</a></li>
<li class="chapter" data-level="8.6" data-path="nse.html"><a href="nse.html#what-is-tidy-evaluation"><i class="fa fa-check"></i><b>8.6</b> What is tidy evaluation?</a></li>
<li class="chapter" data-level="8.7" data-path="nse.html"><a href="nse.html#what-have-we-learned"><i class="fa fa-check"></i><b>8.7</b> What have we learned?</a></li>
<li class="chapter" data-level="8.8" data-path="nse.html"><a href="nse.html#key-points-6"><i class="fa fa-check"></i><b>8.8</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="oop.html"><a href="oop.html"><i class="fa fa-check"></i><b>9</b> Object-Oriented Programming</a><ul>
<li class="chapter" data-level="9.1" data-path="oop.html"><a href="oop.html#questions-7"><i class="fa fa-check"></i><b>9.1</b> Questions</a></li>
<li class="chapter" data-level="9.2" data-path="oop.html"><a href="oop.html#learning-objectives-7"><i class="fa fa-check"></i><b>9.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="9.3" data-path="oop.html"><a href="oop.html#what-are-attributes"><i class="fa fa-check"></i><b>9.3</b> What are attributes?</a></li>
<li class="chapter" data-level="9.4" data-path="oop.html"><a href="oop.html#how-are-classes-represented"><i class="fa fa-check"></i><b>9.4</b> How are classes represented?</a></li>
<li class="chapter" data-level="9.5" data-path="oop.html"><a href="oop.html#how-does-inheritance-work"><i class="fa fa-check"></i><b>9.5</b> How does inheritance work?</a></li>
<li class="chapter" data-level="9.6" data-path="oop.html"><a href="oop.html#key-points-7"><i class="fa fa-check"></i><b>9.6</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="debt.html"><a href="debt.html"><i class="fa fa-check"></i><b>10</b> Intellectual Debt</a><ul>
<li class="chapter" data-level="10.1" data-path="debt.html"><a href="debt.html#questions-8"><i class="fa fa-check"></i><b>10.1</b> Questions</a></li>
<li class="chapter" data-level="10.2" data-path="debt.html"><a href="debt.html#learning-objectives-8"><i class="fa fa-check"></i><b>10.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="10.3" data-path="debt.html"><a href="debt.html#why-shouldnt-i-use-setwd"><i class="fa fa-check"></i><b>10.3</b> Why shouldn’t I use <code>setwd</code>?</a></li>
<li class="chapter" data-level="10.4" data-path="debt.html"><a href="debt.html#how-do-i-write-formulas"><i class="fa fa-check"></i><b>10.4</b> How do I write formulas?</a></li>
<li class="chapter" data-level="10.5" data-path="debt.html"><a href="debt.html#what-the-hell-are-factors"><i class="fa fa-check"></i><b>10.5</b> What the hell are factors?</a></li>
<li class="chapter" data-level="10.6" data-path="debt.html"><a href="debt.html#how-do-i-refer-to-various-arguments-in-a-pipeline"><i class="fa fa-check"></i><b>10.6</b> How do I refer to various arguments in a pipeline?</a></li>
<li class="chapter" data-level="10.7" data-path="debt.html"><a href="debt.html#how-does-r-give-the-appearance-of-immutable-data"><i class="fa fa-check"></i><b>10.7</b> How does R give the appearance of immutable data?</a></li>
<li class="chapter" data-level="10.8" data-path="debt.html"><a href="debt.html#what-else-should-i-worry-about"><i class="fa fa-check"></i><b>10.8</b> What else should I worry about?</a></li>
<li class="chapter" data-level="10.9" data-path="debt.html"><a href="debt.html#key-points-8"><i class="fa fa-check"></i><b>10.9</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="projects.html"><a href="projects.html"><i class="fa fa-check"></i><b>11</b> Projects</a><ul>
<li class="chapter" data-level="11.1" data-path="projects.html"><a href="projects.html#questions-9"><i class="fa fa-check"></i><b>11.1</b> Questions</a></li>
<li class="chapter" data-level="11.2" data-path="projects.html"><a href="projects.html#learning-objectives-9"><i class="fa fa-check"></i><b>11.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="11.3" data-path="projects.html"><a href="projects.html#whats-in-an-r-package"><i class="fa fa-check"></i><b>11.3</b> What’s in an R package?</a></li>
<li class="chapter" data-level="11.4" data-path="projects.html"><a href="projects.html#how-do-i-create-a-package"><i class="fa fa-check"></i><b>11.4</b> How do I create a package?</a></li>
<li class="chapter" data-level="11.5" data-path="projects.html"><a href="projects.html#key-points-9"><i class="fa fa-check"></i><b>11.5</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="shiny.html"><a href="shiny.html"><i class="fa fa-check"></i><b>12</b> Web Applications</a><ul>
<li class="chapter" data-level="12.1" data-path="shiny.html"><a href="shiny.html#questions-10"><i class="fa fa-check"></i><b>12.1</b> Questions</a></li>
<li class="chapter" data-level="12.2" data-path="shiny.html"><a href="shiny.html#learning-objectives-10"><i class="fa fa-check"></i><b>12.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="12.3" data-path="shiny.html"><a href="shiny.html#how-do-i-set-up-a-simple-application"><i class="fa fa-check"></i><b>12.3</b> How do I set up a simple application?</a></li>
<li class="chapter" data-level="12.4" data-path="shiny.html"><a href="shiny.html#how-do-i-create-a-user-interface"><i class="fa fa-check"></i><b>12.4</b> How do I create a user interface?</a></li>
<li class="chapter" data-level="12.5" data-path="shiny.html"><a href="shiny.html#how-do-i-create-a-server"><i class="fa fa-check"></i><b>12.5</b> How do I create a server?</a></li>
<li class="chapter" data-level="12.6" data-path="shiny.html"><a href="shiny.html#how-do-i-run-my-application"><i class="fa fa-check"></i><b>12.6</b> How do I run my application?</a></li>
<li class="chapter" data-level="12.7" data-path="shiny.html"><a href="shiny.html#how-can-i-improve-my-user-interface"><i class="fa fa-check"></i><b>12.7</b> How can I improve my user interface?</a></li>
<li class="chapter" data-level="12.8" data-path="shiny.html"><a href="shiny.html#how-can-i-display-the-data-in-a-file"><i class="fa fa-check"></i><b>12.8</b> How can I display the data in a file?</a></li>
<li class="chapter" data-level="12.9" data-path="shiny.html"><a href="shiny.html#how-can-i-break-circular-dependencies"><i class="fa fa-check"></i><b>12.9</b> How can I break circular dependencies?</a></li>
<li class="chapter" data-level="12.10" data-path="shiny.html"><a href="shiny.html#how-can-i-control-how-the-user-interface-is-rendered"><i class="fa fa-check"></i><b>12.10</b> How can I control how the user interface is rendered?</a></li>
<li class="chapter" data-level="12.11" data-path="shiny.html"><a href="shiny.html#key-points-10"><i class="fa fa-check"></i><b>12.11</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="python.html"><a href="python.html"><i class="fa fa-check"></i><b>13</b> Using Python</a><ul>
<li class="chapter" data-level="13.1" data-path="python.html"><a href="python.html#questions-11"><i class="fa fa-check"></i><b>13.1</b> Questions</a></li>
<li class="chapter" data-level="13.2" data-path="python.html"><a href="python.html#learning-objectives-11"><i class="fa fa-check"></i><b>13.2</b> Learning Objectives</a></li>
<li class="chapter" data-level="13.3" data-path="python.html"><a href="python.html#how-can-i-access-data-across-languages"><i class="fa fa-check"></i><b>13.3</b> How can I access data across languages?</a></li>
<li class="chapter" data-level="13.4" data-path="python.html"><a href="python.html#how-can-i-call-functions-across-languages"><i class="fa fa-check"></i><b>13.4</b> How can I call functions across languages?</a></li>
<li class="chapter" data-level="13.5" data-path="python.html"><a href="python.html#key-points-11"><i class="fa fa-check"></i><b>13.5</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="license.html"><a href="license.html"><i class="fa fa-check"></i><b>A</b> License</a></li>
<li class="chapter" data-level="B" data-path="code-of-conduct.html"><a href="code-of-conduct.html"><i class="fa fa-check"></i><b>B</b> Code of Conduct</a><ul>
<li class="chapter" data-level="B.1" data-path="code-of-conduct.html"><a href="code-of-conduct.html#our-standards"><i class="fa fa-check"></i><b>B.1</b> Our Standards</a></li>
<li class="chapter" data-level="B.2" data-path="code-of-conduct.html"><a href="code-of-conduct.html#our-responsibilities"><i class="fa fa-check"></i><b>B.2</b> Our Responsibilities</a></li>
<li class="chapter" data-level="B.3" data-path="code-of-conduct.html"><a href="code-of-conduct.html#scope"><i class="fa fa-check"></i><b>B.3</b> Scope</a></li>
<li class="chapter" data-level="B.4" data-path="code-of-conduct.html"><a href="code-of-conduct.html#enforcement"><i class="fa fa-check"></i><b>B.4</b> Enforcement</a></li>
<li class="chapter" data-level="B.5" data-path="code-of-conduct.html"><a href="code-of-conduct.html#attribution"><i class="fa fa-check"></i><b>B.5</b> Attribution</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="citation.html"><a href="citation.html"><i class="fa fa-check"></i><b>C</b> Citation</a></li>
<li class="chapter" data-level="D" data-path="contributing.html"><a href="contributing.html"><i class="fa fa-check"></i><b>D</b> Contributing</a></li>
<li class="chapter" data-level="E" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>E</b> Glossary</a></li>
<li class="chapter" data-level="F" data-path="objectives.html"><a href="objectives.html"><i class="fa fa-check"></i><b>F</b> Learning Objectives</a><ul>
<li class="chapter" data-level="F.1" data-path="objectives.html"><a href="objectives.html#values-and-vectors"><i class="fa fa-check"></i><b>F.1</b> Values and Vectors</a></li>
<li class="chapter" data-level="F.2" data-path="objectives.html"><a href="objectives.html#indexing-1"><i class="fa fa-check"></i><b>F.2</b> Indexing</a></li>
<li class="chapter" data-level="F.3" data-path="objectives.html"><a href="objectives.html#control-flow"><i class="fa fa-check"></i><b>F.3</b> Control Flow</a></li>
<li class="chapter" data-level="F.4" data-path="objectives.html"><a href="objectives.html#the-tidyverse"><i class="fa fa-check"></i><b>F.4</b> The Tidyverse</a></li>
<li class="chapter" data-level="F.5" data-path="objectives.html"><a href="objectives.html#cleaning-up-data"><i class="fa fa-check"></i><b>F.5</b> Cleaning Up Data</a></li>
<li class="chapter" data-level="F.6" data-path="objectives.html"><a href="objectives.html#testing-and-error-handling"><i class="fa fa-check"></i><b>F.6</b> Testing and Error Handling</a></li>
<li class="chapter" data-level="F.7" data-path="objectives.html"><a href="objectives.html#non-standard-evaluation"><i class="fa fa-check"></i><b>F.7</b> Non-Standard Evaluation</a></li>
<li class="chapter" data-level="F.8" data-path="objectives.html"><a href="objectives.html#object-oriented-programming"><i class="fa fa-check"></i><b>F.8</b> Object-Oriented Programming</a></li>
<li class="chapter" data-level="F.9" data-path="objectives.html"><a href="objectives.html#intellectual-debt"><i class="fa fa-check"></i><b>F.9</b> Intellectual Debt</a></li>
<li class="chapter" data-level="F.10" data-path="objectives.html"><a href="objectives.html#projects-1"><i class="fa fa-check"></i><b>F.10</b> Projects</a></li>
<li class="chapter" data-level="F.11" data-path="objectives.html"><a href="objectives.html#web-applications-with-shiny"><i class="fa fa-check"></i><b>F.11</b> Web Applications with Shiny</a></li>
<li class="chapter" data-level="F.12" data-path="objectives.html"><a href="objectives.html#reticulate"><i class="fa fa-check"></i><b>F.12</b> Reticulate</a></li>
</ul></li>
<li class="chapter" data-level="G" data-path="keypoints.html"><a href="keypoints.html"><i class="fa fa-check"></i><b>G</b> Key Points</a><ul>
<li class="chapter" data-level="G.1" data-path="keypoints.html"><a href="keypoints.html#values-and-vectors-1"><i class="fa fa-check"></i><b>G.1</b> Values and Vectors</a></li>
<li class="chapter" data-level="G.2" data-path="keypoints.html"><a href="keypoints.html#indexing-2"><i class="fa fa-check"></i><b>G.2</b> Indexing</a></li>
<li class="chapter" data-level="G.3" data-path="keypoints.html"><a href="keypoints.html#control-flow-1"><i class="fa fa-check"></i><b>G.3</b> Control Flow</a></li>
<li class="chapter" data-level="G.4" data-path="keypoints.html"><a href="keypoints.html#the-tidyverse-1"><i class="fa fa-check"></i><b>G.4</b> The Tidyverse</a></li>
<li class="chapter" data-level="G.5" data-path="keypoints.html"><a href="keypoints.html#cleaning-up-data-1"><i class="fa fa-check"></i><b>G.5</b> Cleaning Up Data</a></li>
<li class="chapter" data-level="G.6" data-path="keypoints.html"><a href="keypoints.html#testing-and-error-handling-1"><i class="fa fa-check"></i><b>G.6</b> Testing and Error Handling</a></li>
<li class="chapter" data-level="G.7" data-path="keypoints.html"><a href="keypoints.html#non-standard-evaluation-1"><i class="fa fa-check"></i><b>G.7</b> Non-Standard Evaluation</a></li>
<li class="chapter" data-level="G.8" data-path="keypoints.html"><a href="keypoints.html#object-oriented-programming-1"><i class="fa fa-check"></i><b>G.8</b> Object-Oriented Programming</a></li>
<li class="chapter" data-level="G.9" data-path="keypoints.html"><a href="keypoints.html#intellectual-debt-1"><i class="fa fa-check"></i><b>G.9</b> Intellectual Debt</a></li>
<li class="chapter" data-level="G.10" data-path="keypoints.html"><a href="keypoints.html#projects-2"><i class="fa fa-check"></i><b>G.10</b> Projects</a></li>
<li class="chapter" data-level="G.11" data-path="keypoints.html"><a href="keypoints.html#web-applications-with-shiny-1"><i class="fa fa-check"></i><b>G.11</b> Web Applications with Shiny</a></li>
<li class="chapter" data-level="G.12" data-path="keypoints.html"><a href="keypoints.html#reticulate-1"><i class="fa fa-check"></i><b>G.12</b> Reticulate</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The Tidynomicon</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="cleanup" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Cleaning Up Data</h1>
<div id="questions-4" class="section level2">
<h2><span class="header-section-number">6.1</span> Questions</h2>
<ul>
<li>How do I read tabular data into a program?</li>
<li>How do I control the way missing values are handled while I’m reading data?</li>
<li>What functions should I use to tidy up messy data?</li>
<li>How can I combine partial tables into a single large table?</li>
</ul>
</div>
<div id="learning-objectives-4" class="section level2">
<h2><span class="header-section-number">6.2</span> Learning Objectives</h2>
<ul>
<li>Describe and use the <code>read_csv</code> function.</li>
<li>Describe and use the <code>str_replace</code> function.</li>
<li>Describe and use the <code>is.numeric</code> and <code>as.numeric</code> functions.</li>
<li>Describe and use the <code>map</code> function and its kin.</li>
<li>Describe and use pre-allocation to capture the results of loops.</li>
</ul>
<p>Data is not born tidy.
Here is a sample of data from the original data set <code>raw/infant_hiv.csv</code>,
where <code>...</code> shows values elided to make the segment readable:</p>
<pre class="text"><code>&quot;Early Infant Diagnosis: Percentage of infants born to women living with HIV...&quot;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,2009,,,2010,,,2011,,,2012,,,2013,,,2014,,,2015,,,2016,,,2017,,,
ISO3,Countries,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,...
AFG,Afghanistan,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
ALB,Albania,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
DZA,Algeria,-,-,-,-,-,-,38%,42%,35%,23%,25%,21%,55%,60%,50%,27%,30%,25%,23%,25%,21%,33%,37%,31%,61%,68%,57%,
AGO,Angola,-,-,-,3%,4%,2%,5%,7%,4%,6%,8%,5%,15%,20%,12%,10%,14%,8%,6%,8%,5%,1%,2%,1%,1%,2%,1%,
... many more rows ...
YEM,Yemen,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
ZMB,Zambia,59%,70%,53%,27%,32%,24%,70%,84%,63%,74%,88%,67%,64%,76%,57%,91%,&gt;95%,81%,43%,52%,39%,43%,51%,39%,46%,54%,41%,
ZWE,Zimbabwe,-,-,-,12%,15%,10%,23%,28%,20%,38%,47%,33%,57%,70%,49%,54%,67%,47%,59%,73%,51%,71%,88%,62%,65%,81%,57%,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,2009,,,2010,,,2011,,,2012,,,2013,,,2014,,,2015,,,2016,,,2017,,,
,,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,...
Region,East Asia and the Pacific,25%,30%,22%,35%,42%,29%,30%,37%,26%,32%,38%,27%,28%,34%,24%,26%,31%,22%,31%,37%,27%,30%,35%,25%,28%,33%,24%,
,Eastern and Southern Africa,23%,29%,20%,44%,57%,37%,48%,62%,40%,54%,69%,46%,51%,65%,43%,62%,80%,53%,62%,79%,52%,54%,68%,45%,62%,80%,53%,
,Eastern Europe and Central Asia,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
... several more rows ...
,Sub-Saharan Africa,16%,22%,13%,34%,46%,28%,37%,50%,30%,43%,57%,35%,41%,54%,33%,50%,66%,41%,50%,66%,41%,45%,60%,37%,52%,69%,42%,
,Global,17%,23%,13%,33%,45%,27%,36%,49%,29%,41%,55%,34%,40%,53%,32%,48%,64%,39%,49%,64%,40%,44%,59%,36%,51%,67%,41%,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Indicator definition: Percentage of infants born to women living with HIV... ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Note: Data are not available if country did not submit data...,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Data source: Global AIDS Monitoring 2018 and UNAIDS 2018 estimates,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
&quot;For more information on this indicator, please visit the guidance:...&quot;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
&quot;For more information on the data, visit data.unicef.org&quot;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,</code></pre>
<p>This is a mess—no, more than that, it is an affront to decency.
There are comments mixed with data,
values’ actual indices have to be synthesized by combining column headings from two rows
(two thirds of which have to be carried forward from previous columns),
and so on.
We want to create the tidy data found in <code>tidy/infant_hiv.csv</code>:</p>
<pre class="text"><code>country,year,estimate,hi,lo
AFG,2009,NA,NA,NA
AFG,2010,NA,NA,NA
AFG,2011,NA,NA,NA
AFG,2012,NA,NA,NA
...
ZWE,2016,0.71,0.88,0.62
ZWE,2017,0.65,0.81,0.57</code></pre>
<p>To bring this data to a state of grace will take some trial and effort,
which we shall do in stages.</p>
</div>
<div id="how-do-i-inspect-the-raw-data" class="section level2">
<h2><span class="header-section-number">6.3</span> How do I inspect the raw data?</h2>
<p>We will begin by reading the data into a tibble:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>)</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X2&#39; [2], &#39;X3&#39; [3], &#39;X4&#39; [4],
&#39;X5&#39; [5], &#39;X6&#39; [6], &#39;X7&#39; [7], &#39;X8&#39; [8], &#39;X9&#39; [9], &#39;X10&#39; [10], &#39;X11&#39; [11],
&#39;X12&#39; [12], &#39;X13&#39; [13], &#39;X14&#39; [14], &#39;X15&#39; [15], &#39;X16&#39; [16], &#39;X17&#39; [17],
&#39;X18&#39; [18], &#39;X19&#39; [19], &#39;X20&#39; [20], &#39;X21&#39; [21], &#39;X22&#39; [22], &#39;X23&#39; [23],
&#39;X24&#39; [24], &#39;X25&#39; [25], &#39;X26&#39; [26], &#39;X27&#39; [27], &#39;X28&#39; [28], &#39;X29&#39; [29],
&#39;X30&#39; [30]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(raw)</code></pre>
<pre><code># A tibble: 6 x 30
  `Early Infant D… X2    X3    X4    X5    X6    X7    X8    X9    X10  
  &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
1 &lt;NA&gt;             &lt;NA&gt;  2009  &lt;NA&gt;  &lt;NA&gt;  2010  &lt;NA&gt;  &lt;NA&gt;  2011  &lt;NA&gt; 
2 ISO3             Coun… Esti… hi    lo    Esti… hi    lo    Esti… hi   
3 AFG              Afgh… -     -     -     -     -     -     -     -    
4 ALB              Alba… -     -     -     -     -     -     -     -    
5 DZA              Alge… -     -     -     -     -     -     38%   42%  
6 AGO              Ango… -     -     -     3%    4%    2%    5%    7%   
# … with 20 more variables: X11 &lt;chr&gt;, X12 &lt;chr&gt;, X13 &lt;chr&gt;, X14 &lt;chr&gt;,
#   X15 &lt;chr&gt;, X16 &lt;chr&gt;, X17 &lt;chr&gt;, X18 &lt;chr&gt;, X19 &lt;chr&gt;, X20 &lt;chr&gt;,
#   X21 &lt;chr&gt;, X22 &lt;chr&gt;, X23 &lt;chr&gt;, X24 &lt;chr&gt;, X25 &lt;chr&gt;, X26 &lt;chr&gt;,
#   X27 &lt;chr&gt;, X28 &lt;chr&gt;, X29 &lt;chr&gt;, X30 &lt;chr&gt;</code></pre>
<p>All right:
R isn’t able to infer column names,
so it uses the entire first comment string as a very long column name
and then makes up names for the other columns.
Looking at the file,
the second row has years (spaced at three-column intervals)
and the column after that has the <a href="glossary.html#iso3-country-code">ISO3 country code</a>,
the country’s name,
and then “Estimate”, “hi”, and “lo” repeated for every year.
We are going to have to combine what’s in the second and third rows,
so we’re going to have to do some work no matter which we skip or keep.
Since we want the ISO3 code and the country name,
let’s skip the first two rows.</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>)</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(raw)</code></pre>
<pre><code># A tibble: 6 x 30
  ISO3  Countries Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2
  &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     
1 AFG   Afghanis… -        -     -     -          -     -     -         
2 ALB   Albania   -        -     -     -          -     -     -         
3 DZA   Algeria   -        -     -     -          -     -     38%       
4 AGO   Angola    -        -     -     3%         4%    2%    5%        
5 AIA   Anguilla  -        -     -     -          -     -     -         
6 ATG   Antigua … -        -     -     -          -     -     -         
# … with 21 more variables: hi_2 &lt;chr&gt;, lo_2 &lt;chr&gt;, Estimate_3 &lt;chr&gt;,
#   hi_3 &lt;chr&gt;, lo_3 &lt;chr&gt;, Estimate_4 &lt;chr&gt;, hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;,
#   Estimate_5 &lt;chr&gt;, hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;, Estimate_6 &lt;chr&gt;,
#   hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;, Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;, lo_7 &lt;chr&gt;,
#   Estimate_8 &lt;chr&gt;, hi_8 &lt;chr&gt;, lo_8 &lt;chr&gt;, X30 &lt;chr&gt;</code></pre>
<p>That’s a bit of an improvement,
but why are all the columns <code>character</code> instead of numbers?
This happens because:</p>
<ol style="list-style-type: decimal">
<li>our CSV file uses <code>-</code> (a single dash) to show missing data, and</li>
<li>all of our numbers end with <code>%</code>, which means those values actually <em>are</em> character strings.</li>
</ol>
<p>We will tackle the first problem by setting <code>na = c("-")</code> in our <code>read_csv</code> call
(since we should never do ourselves what a library function will do for us):</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(raw)</code></pre>
<pre><code># A tibble: 6 x 30
  ISO3  Countries Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2
  &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     
1 AFG   Afghanis… &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
2 ALB   Albania   &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
3 DZA   Algeria   &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  38%       
4 AGO   Angola    &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  3%         4%    2%    5%        
5 AIA   Anguilla  &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
6 ATG   Antigua … &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
# … with 21 more variables: hi_2 &lt;chr&gt;, lo_2 &lt;chr&gt;, Estimate_3 &lt;chr&gt;,
#   hi_3 &lt;chr&gt;, lo_3 &lt;chr&gt;, Estimate_4 &lt;chr&gt;, hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;,
#   Estimate_5 &lt;chr&gt;, hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;, Estimate_6 &lt;chr&gt;,
#   hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;, Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;, lo_7 &lt;chr&gt;,
#   Estimate_8 &lt;chr&gt;, hi_8 &lt;chr&gt;, lo_8 &lt;chr&gt;, X30 &lt;chr&gt;</code></pre>
<p>That’s progress.
We now need to strip the percentage signs and convert what’s left to numeric values.
To simplify our lives,
let’s get the <code>ISO3</code> and <code>Countries</code> columns out of the way.
We will save the ISO3 values for later use
(and because it will illustrate a point about data hygiene that we want to make later,
but which we don’t want to reveal just yet).</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">countries &lt;-<span class="st"> </span>raw<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</code></pre>
<pre><code>Error in filter_impl(.data, quo): Evaluation error: invalid argument to unary operator.</code></pre>
<p>In the Hollywood version of this lesson,
we would sigh heavily at this point as we realize that we should have called <code>select</code>, not <code>filter</code>.
Once we make that change,
we can move forward once again:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">countries &lt;-<span class="st"> </span>raw<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
<span class="kw">head</span>(body)</code></pre>
<pre><code># A tibble: 6 x 28
  Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2 hi_2  lo_2 
  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;
1 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
2 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
3 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  38%        42%   35%  
4 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  3%         4%    2%    5%         7%    4%   
5 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
6 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
# … with 19 more variables: Estimate_3 &lt;chr&gt;, hi_3 &lt;chr&gt;, lo_3 &lt;chr&gt;,
#   Estimate_4 &lt;chr&gt;, hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;, Estimate_5 &lt;chr&gt;,
#   hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;, Estimate_6 &lt;chr&gt;, hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;,
#   Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;, lo_7 &lt;chr&gt;, Estimate_8 &lt;chr&gt;,
#   hi_8 &lt;chr&gt;, lo_8 &lt;chr&gt;, X30 &lt;chr&gt;</code></pre>
<p>But wait.
Weren’t there some aggregate lines of data at the end of our input?
What happened to them?</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tail</span>(countries, <span class="dt">n =</span> <span class="dv">25</span>)</code></pre>
<pre><code> [1] &quot;YEM&quot;                                                                                                                                                       
 [2] &quot;ZMB&quot;                                                                                                                                                       
 [3] &quot;ZWE&quot;                                                                                                                                                       
 [4] &quot;&quot;                                                                                                                                                          
 [5] &quot;&quot;                                                                                                                                                          
 [6] &quot;&quot;                                                                                                                                                          
 [7] &quot;Region&quot;                                                                                                                                                    
 [8] &quot;&quot;                                                                                                                                                          
 [9] &quot;&quot;                                                                                                                                                          
[10] &quot;&quot;                                                                                                                                                          
[11] &quot;&quot;                                                                                                                                                          
[12] &quot;&quot;                                                                                                                                                          
[13] &quot;&quot;                                                                                                                                                          
[14] &quot;&quot;                                                                                                                                                          
[15] &quot;&quot;                                                                                                                                                          
[16] &quot;Super-region&quot;                                                                                                                                              
[17] &quot;&quot;                                                                                                                                                          
[18] &quot;&quot;                                                                                                                                                          
[19] &quot;&quot;                                                                                                                                                          
[20] &quot;&quot;                                                                                                                                                          
[21] &quot;Indicator definition: Percentage of infants born to women living with HIV receiving a virological test for HIV within two months of birth&quot;                 
[22] &quot;Note: Data are not available if country did not submit data to Global AIDS Monitoring or if estimates of pregnant women living with HIV are not published.&quot;
[23] &quot;Data source: Global AIDS Monitoring 2018 and UNAIDS 2018 estimates&quot;                                                                                        
[24] &quot;For more information on this indicator, please visit the guidance: http://www.unaids.org/sites/default/files/media_asset/global-aids-monitoring_en.pdf&quot;    
[25] &quot;For more information on the data, visit data.unicef.org&quot;                                                                                                   </code></pre>
<p>Once again the actor playing our part on screen sighs heavily.
How are we to trim this?
Since there is only one file,
we can manually count the number of rows we are interested in
(or rather, open the file with an editor or spreadsheet program, scroll down, and check the line number),
and then slice there.
This is a very bad idea if we’re planning to use this script on other files—we should
instead look for the first blank line or the entry for Zimbabwe or something like that—but
let’s revisit the problem once we have our data in place.</p>
<pre class="sourceCode r"><code class="sourceCode r">num_rows &lt;-<span class="st"> </span><span class="dv">192</span>
raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span>num_rows)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
<span class="kw">tail</span>(countries, <span class="dt">n =</span> <span class="dv">5</span>)</code></pre>
<pre><code>[1] &quot;VEN&quot; &quot;VNM&quot; &quot;YEM&quot; &quot;ZMB&quot; &quot;ZWE&quot;</code></pre>
<p>Notice that we’re counting rows <em>not including</em> the two we’re skipping,
which means that the 192 in the call to <code>slice</code> above corresponds to row 195 of our original data:
195, not 194, because we’re using the first row of unskipped data as headers and yes,
you are in fact making that faint whimpering sound you now hear.
You will hear it often when dealing with real-world data…</p>
<p>And notice also that we are slicing, <em>then</em> extracting the column containing the countries.
We did, in a temporary version of this script,
peel off the countries, slice those, and then wonder why our main data table still had unwanted data at the end.
Vigilance, my friends—vigilance shall be our watchword,
and in light of that,
we shall first test our plan for converting our strings to numbers:</p>
<pre class="sourceCode r"><code class="sourceCode r">fixture &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&quot;1%&quot;</span>, <span class="st">&quot;10%&quot;</span>, <span class="st">&quot;100%&quot;</span>)
result &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">str_replace</span>(fixture, <span class="st">&quot;%&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>
result</code></pre>
<pre><code>[1]   NA 0.01 0.10 1.00</code></pre>
<p>And as a further check:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is.numeric</span>(result)</code></pre>
<pre><code>[1] TRUE</code></pre>
<p>The function <code>is.numeric</code> is <code>TRUE</code> for both <code>NA</code> and actual numbers,
so it is doing the right thing here,
and so are we.
Our updated conversion script is now:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
numbers &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">str_replace</span>(body, <span class="st">&quot;%&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></code></pre>
<pre><code>Warning in stri_replace_first_regex(string, pattern,
fix_replacement(replacement), : argument is not an atomic vector; coercing</code></pre>
<pre><code>Warning: NAs introduced by coercion</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is.numeric</span>(numbers)</code></pre>
<pre><code>[1] TRUE</code></pre>
<p>Oh dear.
It appears that some function that <code>str_replace</code> is calling is expecting an atomic vector,
not a tibble.
It worked for our test case because that was a character vector,
but tibbles have more structure than that.</p>
<p>The second complaint is that <code>NA</code>s were introduced,
which is troubling because we didn’t get a complaint when we had actual <code>NA</code>s in our data.
However,
<code>is.numeric</code> tells us that all of our results are numbers.
Let’s take a closer look:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is_tibble</span>(body)</code></pre>
<pre><code>[1] TRUE</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">is_tibble</span>(numbers)</code></pre>
<pre><code>[1] FALSE</code></pre>
<p>Perdition.
After browsing the data,
we realize that some entries are <code>"&gt;95%"</code>,
i.e.,
there is a greater-than sign as well as a percentage in the text.
We will need to regularize those before we do any conversions.</p>
<p>Before that,
however,
let’s see if we can get rid of the percent signs.
The obvious way is is to use <code>str_replace(body, "%", "")</code>,
but that doesn’t work:
<code>str_replace</code> works on vectors,
but a tibble is a list of vectors.
Instead,
we can use a <a href="glossary.html#higher-order-function">higher-order function</a> called <code>map</code>
to apply the function <code>str_replace</code> to each column in turn to get rid of the percent signs:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
trimmed &lt;-<span class="st"> </span><span class="kw">map</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>)
<span class="kw">head</span>(trimmed)</code></pre>
<pre><code>$Estimate
  [1] NA         NA         NA         NA         NA         NA        
  [7] NA         NA         NA         NA         &quot;26&quot;       NA        
 [13] NA         NA         NA         &quot;&gt;95&quot;      NA         &quot;77&quot;      
 [19] NA         NA         &quot;7&quot;        NA         NA         &quot;25&quot;      
 [25] NA         NA         &quot;3&quot;        NA         &quot;&gt;95&quot;      NA        
 [31] &quot;27&quot;       NA         &quot;1&quot;        NA         NA         NA        
 [37] &quot;5&quot;        NA         &quot;8&quot;        NA         &quot;92&quot;       NA        
 [43] NA         &quot;83&quot;       NA         NA         NA         NA        
 [49] NA         NA         NA         &quot;28&quot;       &quot;1&quot;        &quot;4&quot;       
 [55] NA         NA         NA         NA         &quot;4&quot;        NA        
 [61] NA         NA         NA         NA         &quot;61&quot;       NA        
 [67] NA         NA         NA         NA         NA         NA        
 [73] NA         NA         &quot;61&quot;       NA         NA         NA        
 [79] NA         &quot;2&quot;        NA         NA         NA         NA        
 [85] NA         NA         NA         &quot;&gt;95&quot;      NA         NA        
 [91] NA         NA         NA         NA         NA         &quot;43&quot;      
 [97] &quot;5&quot;        NA         NA         NA         NA         NA        
[103] &quot;37&quot;       NA         &quot;8&quot;        NA         NA         NA        
[109] NA         NA         NA         NA         NA         &quot;2&quot;       
[115] NA         NA         NA         NA         &quot;2&quot;        NA        
[121] NA         &quot;50&quot;       NA         &quot;4&quot;        NA         NA        
[127] NA         &quot;1&quot;        NA         NA         NA         NA        
[133] NA         NA         &quot;1&quot;        NA         NA         NA        
[139] &quot;&gt;95&quot;      NA         NA         &quot;58&quot;       NA         NA        
[145] NA         NA         NA         NA         &quot;11&quot;       NA        
[151] NA         NA         NA         NA         NA         NA        
[157] NA         NA         NA         NA         NA         NA        
[163] &quot;9&quot;        NA         NA         NA         NA         &quot;1&quot;       
[169] NA         NA         NA         &quot;7&quot;        NA         NA        
[175] NA         NA         NA         NA         &quot;8&quot;        &quot;78&quot;      
[181] NA         NA         &quot;13&quot;       NA         NA         &quot;0&quot;       
[187] NA         NA         NA         NA         &quot;59&quot;       NA        
[193] &quot;&quot;         &quot;2009&quot;     &quot;Estimate&quot; &quot;25&quot;       &quot;23&quot;       NA        
[199] &quot;24&quot;       &quot;2&quot;        NA         &quot;1&quot;        &quot;8&quot;        NA        
[205] &quot;7&quot;        &quot;72&quot;       &quot;16&quot;       &quot;17&quot;       &quot;&quot;         &quot;&quot;        
[211] &quot;&quot;         &quot;&quot;         &quot;&quot;         &quot;&quot;        

$hi
  [1] NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    &quot;35&quot; 
...</code></pre>
<p>Perdition once again.
The problem now is that <code>map</code> produces a raw list as output.
The function we want is <code>map_dfr</code>,
which maps a function across the rows of a tibble and returns a tibble as a result.
(There is a corresponding function <code>map_dfc</code> that maps a function across columns.)</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>)
<span class="kw">head</span>(trimmed)</code></pre>
<pre><code># A tibble: 6 x 28
  Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2 hi_2  lo_2 
  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt;
1 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
2 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
3 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  38         42    35   
4 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  3          4     2     5          7     4    
5 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
6 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt; 
# … with 19 more variables: Estimate_3 &lt;chr&gt;, hi_3 &lt;chr&gt;, lo_3 &lt;chr&gt;,
#   Estimate_4 &lt;chr&gt;, hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;, Estimate_5 &lt;chr&gt;,
#   hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;, Estimate_6 &lt;chr&gt;, hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;,
#   Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;, lo_7 &lt;chr&gt;, Estimate_8 &lt;chr&gt;,
#   hi_8 &lt;chr&gt;, lo_8 &lt;chr&gt;, X30 &lt;chr&gt;</code></pre>
<p>Now to tackle those <code>"&gt;95%"</code> values.
It turns out that <code>str_replace</code> uses <a href="glossary.html#regular-expression">regular expressions</a>,
not just direct string matches,
so we can get rid of the <code>&gt;</code> at the same time as we get rid of the <code>%</code>.
We will check by looking at the first <code>Estimate</code> column,
which earlier inspection informed us had at least one <code>"&gt;95%"</code> in it:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)
trimmed<span class="op">$</span>Estimate</code></pre>
<pre><code>  [1] NA         NA         NA         NA         NA         NA        
  [7] NA         NA         NA         NA         &quot;26&quot;       NA        
 [13] NA         NA         NA         &quot;95&quot;       NA         &quot;77&quot;      
 [19] NA         NA         &quot;7&quot;        NA         NA         &quot;25&quot;      
 [25] NA         NA         &quot;3&quot;        NA         &quot;95&quot;       NA        
 [31] &quot;27&quot;       NA         &quot;1&quot;        NA         NA         NA        
 [37] &quot;5&quot;        NA         &quot;8&quot;        NA         &quot;92&quot;       NA        
 [43] NA         &quot;83&quot;       NA         NA         NA         NA        
 [49] NA         NA         NA         &quot;28&quot;       &quot;1&quot;        &quot;4&quot;       
 [55] NA         NA         NA         NA         &quot;4&quot;        NA        
 [61] NA         NA         NA         NA         &quot;61&quot;       NA        
 [67] NA         NA         NA         NA         NA         NA        
 [73] NA         NA         &quot;61&quot;       NA         NA         NA        
 [79] NA         &quot;2&quot;        NA         NA         NA         NA        
 [85] NA         NA         NA         &quot;95&quot;       NA         NA        
 [91] NA         NA         NA         NA         NA         &quot;43&quot;      
 [97] &quot;5&quot;        NA         NA         NA         NA         NA        
[103] &quot;37&quot;       NA         &quot;8&quot;        NA         NA         NA        
[109] NA         NA         NA         NA         NA         &quot;2&quot;       
[115] NA         NA         NA         NA         &quot;2&quot;        NA        
...</code></pre>
<p>Excellent.
We can now use <code>map_dfr</code> to convert the columns to numeric percentages
using an <a href="glossary.html#anonymous-function">anonymous function</a> that we define inside the <code>map_dfr</code> call itself:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)
percents &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(trimmed, <span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</code></pre>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(percents)</code></pre>
<pre><code># A tibble: 6 x 28
  Estimate    hi    lo Estimate_1  hi_1  lo_1 Estimate_2  hi_2  lo_2
     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1       NA    NA    NA      NA    NA    NA         NA    NA    NA   
2       NA    NA    NA      NA    NA    NA         NA    NA    NA   
3       NA    NA    NA      NA    NA    NA          0.38  0.42  0.35
4       NA    NA    NA       0.03  0.04  0.02       0.05  0.07  0.04
5       NA    NA    NA      NA    NA    NA         NA    NA    NA   
6       NA    NA    NA      NA    NA    NA         NA    NA    NA   
# … with 19 more variables: Estimate_3 &lt;dbl&gt;, hi_3 &lt;dbl&gt;, lo_3 &lt;dbl&gt;,
#   Estimate_4 &lt;dbl&gt;, hi_4 &lt;dbl&gt;, lo_4 &lt;dbl&gt;, Estimate_5 &lt;dbl&gt;,
#   hi_5 &lt;dbl&gt;, lo_5 &lt;dbl&gt;, Estimate_6 &lt;dbl&gt;, hi_6 &lt;dbl&gt;, lo_6 &lt;dbl&gt;,
#   Estimate_7 &lt;dbl&gt;, hi_7 &lt;dbl&gt;, lo_7 &lt;dbl&gt;, Estimate_8 &lt;dbl&gt;,
#   hi_8 &lt;dbl&gt;, lo_8 &lt;dbl&gt;, X30 &lt;dbl&gt;</code></pre>
<p>27 warnings is rather a lot,
so let’s see what running <code>warnings()</code> produces right after the <code>as.numeric</code> call:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)
percents &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(trimmed, <span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</code></pre>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">warnings</span>()</code></pre>
<p>Something is still not right.
The first <code>Estimates</code> column looks all right,
so let’s have a look at the second column:</p>
<pre class="sourceCode r"><code class="sourceCode r">trimmed<span class="op">$</span>hi</code></pre>
<pre><code>  [1] NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   &quot;35&quot; NA   NA   NA  
 [15] NA   &quot;95&quot; NA   &quot;89&quot; NA   NA   &quot;10&quot; NA   NA   &quot;35&quot; NA   NA   &quot;5&quot;  NA  
 [29] &quot;95&quot; NA   &quot;36&quot; NA   &quot;1&quot;  NA   NA   NA   &quot;6&quot;  NA   &quot;12&quot; NA   &quot;95&quot; NA  
 [43] NA   &quot;95&quot; NA   NA   NA   NA   NA   NA   NA   &quot;36&quot; &quot;1&quot;  &quot;4&quot;  NA   NA  
 [57] NA   NA   &quot;6&quot;  NA   NA   NA   NA   NA   &quot;77&quot; NA   NA   NA   NA   NA  
 [71] NA   NA   NA   NA   &quot;74&quot; NA   NA   NA   NA   &quot;2&quot;  NA   NA   NA   NA  
 [85] NA   NA   NA   &quot;95&quot; NA   NA   NA   NA   NA   NA   NA   &quot;53&quot; &quot;7&quot;  NA  
 [99] NA   NA   NA   NA   &quot;44&quot; NA   &quot;9&quot;  NA   NA   NA   NA   NA   NA   NA  
[113] NA   &quot;2&quot;  NA   NA   NA   NA   &quot;2&quot;  NA   NA   &quot;69&quot; NA   &quot;7&quot;  NA   NA  
[127] NA   &quot;1&quot;  NA   NA   NA   NA   NA   NA   &quot;1&quot;  NA   NA   NA   &quot;95&quot; NA  
[141] NA   &quot;75&quot; NA   NA   NA   NA   NA   NA   &quot;13&quot; NA   NA   NA   NA   NA  
[155] NA   NA   NA   NA   NA   NA   NA   NA   &quot;11&quot; NA   NA   NA   NA   &quot;1&quot; 
[169] NA   NA   NA   &quot;12&quot; NA   NA   NA   NA   NA   NA   &quot;9&quot;  &quot;95&quot; NA   NA  
[183] &quot;16&quot; NA   NA   &quot;1&quot;  NA   NA   NA   NA   &quot;70&quot; NA   &quot;&quot;   &quot;&quot;   &quot;hi&quot; &quot;30&quot;
[197] &quot;29&quot; NA   &quot;32&quot; &quot;2&quot;  NA   &quot;2&quot;  &quot;12&quot; NA   &quot;9&quot;  &quot;89&quot; &quot;22&quot; &quot;23&quot; &quot;&quot;   &quot;&quot;  
[211] &quot;&quot;   &quot;&quot;   &quot;&quot;   &quot;&quot;  </code></pre>
<p>Where are those empty strings coming from?
Let’s backtrack by examining the <code>hi</code> column of each of our intermediate variables interactively in the console…</p>
<p>…and there’s our bug.
We are creating a variable called <code>sliced</code> that has only the rows we care about,
but then using the full table in <code>raw</code> to create <code>body</code>.
It’s a simple mistake,
and one that could easily have slipped by us.
Here is our revised script:</p>
<pre class="sourceCode r"><code class="sourceCode r">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)
countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3
body &lt;-<span class="st"> </span>sliced <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)
trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)
percents &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(trimmed, <span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</code></pre>
<p>and here are the checks on the head:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(percents)</code></pre>
<pre><code># A tibble: 6 x 28
  Estimate    hi    lo Estimate_1  hi_1  lo_1 Estimate_2  hi_2  lo_2
     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1       NA    NA    NA      NA    NA    NA         NA    NA    NA   
2       NA    NA    NA      NA    NA    NA         NA    NA    NA   
3       NA    NA    NA      NA    NA    NA          0.38  0.42  0.35
4       NA    NA    NA       0.03  0.04  0.02       0.05  0.07  0.04
5       NA    NA    NA      NA    NA    NA         NA    NA    NA   
6       NA    NA    NA      NA    NA    NA         NA    NA    NA   
# … with 19 more variables: Estimate_3 &lt;dbl&gt;, hi_3 &lt;dbl&gt;, lo_3 &lt;dbl&gt;,
#   Estimate_4 &lt;dbl&gt;, hi_4 &lt;dbl&gt;, lo_4 &lt;dbl&gt;, Estimate_5 &lt;dbl&gt;,
#   hi_5 &lt;dbl&gt;, lo_5 &lt;dbl&gt;, Estimate_6 &lt;dbl&gt;, hi_6 &lt;dbl&gt;, lo_6 &lt;dbl&gt;,
#   Estimate_7 &lt;dbl&gt;, hi_7 &lt;dbl&gt;, lo_7 &lt;dbl&gt;, Estimate_8 &lt;dbl&gt;,
#   hi_8 &lt;dbl&gt;, lo_8 &lt;dbl&gt;, X30 &lt;dbl&gt;</code></pre>
<p>and tail:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tail</span>(percents)</code></pre>
<pre><code># A tibble: 6 x 28
  Estimate    hi    lo Estimate_1  hi_1  lo_1 Estimate_2  hi_2  lo_2
     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1    NA     NA   NA         NA    NA    NA         NA    NA    NA   
2    NA     NA   NA         NA    NA    NA         NA    NA    NA   
3    NA     NA   NA         NA    NA    NA          0.31  0.37  0.26
4    NA     NA   NA         NA    NA    NA         NA    NA    NA   
5     0.59   0.7  0.53       0.27  0.32  0.24       0.7   0.84  0.63
6    NA     NA   NA          0.12  0.15  0.1        0.23  0.28  0.2 
# … with 19 more variables: Estimate_3 &lt;dbl&gt;, hi_3 &lt;dbl&gt;, lo_3 &lt;dbl&gt;,
#   Estimate_4 &lt;dbl&gt;, hi_4 &lt;dbl&gt;, lo_4 &lt;dbl&gt;, Estimate_5 &lt;dbl&gt;,
#   hi_5 &lt;dbl&gt;, lo_5 &lt;dbl&gt;, Estimate_6 &lt;dbl&gt;, hi_6 &lt;dbl&gt;, lo_6 &lt;dbl&gt;,
#   Estimate_7 &lt;dbl&gt;, hi_7 &lt;dbl&gt;, lo_7 &lt;dbl&gt;, Estimate_8 &lt;dbl&gt;,
#   hi_8 &lt;dbl&gt;, lo_8 &lt;dbl&gt;, X30 &lt;dbl&gt;</code></pre>
<p>Comparing this to the raw data file convinces us that yes,
we are now converting the percentages properly,
which means we are halfway home.</p>
</div>
<div id="how-do-i-tidy-the-data" class="section level2">
<h2><span class="header-section-number">6.4</span> How do I tidy the data?</h2>
<p>We now have numeric values in <code>percents</code> and corresponding ISO3 codes in <code>countries</code>.
What we do <em>not</em> have is tidy data:
countries are not associated with records,
years are not recorded at all,
and the column headers for <code>percents</code> have mostly been manufactured for us by R.
We must now sew these parts together like Dr. Frankenstein’s trusty assistant Igor
(who, like so many lab assistants, did most of the actual work but was given only crumbs of credit).</p>
<p>We could write a loop to grab three columns at a time and relabel them,
but a more concise solution makes use of two functions called <code>gather</code> and <code>separate</code>.
<code>gather</code> takes multiple columns and collapses them into key-value pairs.
To show how it works,
let’s create a small tibble by hand using the function <code>tribble</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">small &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>ISO, <span class="op">~</span>est, <span class="op">~</span>hi, <span class="op">~</span>lo,
  <span class="st">&#39;ABC&#39;</span>, <span class="fl">0.25</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>,
  <span class="st">&#39;DEF&#39;</span>, <span class="fl">0.55</span>, <span class="fl">0.6</span>, <span class="fl">0.5</span>
)
small</code></pre>
<pre><code># A tibble: 2 x 4
  ISO     est    hi    lo
  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 ABC    0.25   0.3   0.2
2 DEF    0.55   0.6   0.5</code></pre>
<p>and then gather the three columns <code>est</code>, <code>hi</code>, and <code>lo</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">small <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">&quot;kind&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;reported&quot;</span>, est, hi, lo)</code></pre>
<pre><code># A tibble: 6 x 3
  ISO   kind  reported
  &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
1 ABC   est       0.25
2 DEF   est       0.55
3 ABC   hi        0.3 
4 DEF   hi        0.6 
5 ABC   lo        0.2 
6 DEF   lo        0.5 </code></pre>
<p>The <code>key</code> and <code>value</code> parameters tell <code>gather</code> to create new columns with the specified names
(in this case, <code>kind</code> and <code>reported</code>).
The first of these columns (<code>kind</code> in our case) is filled by repeating the column headings from the original tibble;
the second column (<code>reported</code> in our case) is then filled with the original tibble’s values.</p>
<p><code>separate</code> splits one column into two.
For example, if we have the year and the heading type in a single column:</p>
<pre class="sourceCode r"><code class="sourceCode r">single &lt;-<span class="st"> </span><span class="kw">tribble</span>(
  <span class="op">~</span>combined, <span class="op">~</span>value,
  <span class="st">&#39;2009-est&#39;</span>, <span class="dv">123</span>,
  <span class="st">&#39;2009-hi&#39;</span>,  <span class="dv">456</span>,
  <span class="st">&#39;2009-lo&#39;</span>,  <span class="dv">789</span>,
  <span class="st">&#39;2010-est&#39;</span>, <span class="dv">987</span>,
  <span class="st">&#39;2010-hi&#39;</span>,  <span class="dv">654</span>,
  <span class="st">&#39;2010-lo&#39;</span>,  <span class="dv">321</span>
)
single</code></pre>
<pre><code># A tibble: 6 x 2
  combined value
  &lt;chr&gt;    &lt;dbl&gt;
1 2009-est   123
2 2009-hi    456
3 2009-lo    789
4 2010-est   987
5 2010-hi    654
6 2010-lo    321</code></pre>
<p>we can get the year and the heading into separate columns by separating on the <code>-</code> character:</p>
<pre class="sourceCode r"><code class="sourceCode r">single <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">separate</span>(combined, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>))</code></pre>
<pre><code># A tibble: 6 x 3
  year  kind  value
  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
1 2009  est     123
2 2009  hi      456
3 2009  lo      789
4 2010  est     987
5 2010  hi      654
6 2010  lo      321</code></pre>
<p>Our strategy is therefore going to be:</p>
<ol style="list-style-type: decimal">
<li>Replace the double column headers in the existing data with a single header that combines the year with the kind.</li>
<li>Gather the data so that the year-kind values are in a single column.</li>
<li>Split that column.</li>
</ol>
<p>We’ve seen the tools we need for the second and third step;
the first involves a little bit of list manipulation.
Let’s start by repeating <code>"est"</code>, <code>"hi"</code>, and <code>"lo"</code> as many times as we need them:</p>
<pre class="sourceCode r"><code class="sourceCode r">num_years &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2017</span> <span class="op">-</span><span class="st"> </span><span class="dv">2009</span>
kinds &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;est&quot;</span>, <span class="st">&quot;hi&quot;</span>, <span class="st">&quot;lo&quot;</span>), num_years)
kinds</code></pre>
<pre><code> [1] &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot; 
[12] &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot;
[23] &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot; </code></pre>
<p>As you can probably guess from its name,
<code>rep</code> repeats things a specified number of times,
and as noted previously,
a vector of vectors is flattened into a single vector.</p>
<p>What about the years?
We want to wind up with:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;2009&quot;</span>, <span class="st">&quot;2009&quot;</span> <span class="st">&quot;2009&quot;</span>, <span class="st">&quot;2010&quot;</span>, <span class="st">&quot;2010&quot;</span>, <span class="st">&quot;2010&quot;</span>, ...)</code></pre>
<p>i.e., with each year repeated three times.
<code>rep</code> won’t do this,
but we can get there with <code>map</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">years &lt;-<span class="st"> </span><span class="kw">map</span>(<span class="dv">2009</span><span class="op">:</span><span class="dv">2017</span>, rep, <span class="dv">3</span>)
years</code></pre>
<pre><code>[[1]]
[1] 2009 2009 2009

[[2]]
[1] 2010 2010 2010

[[3]]
[1] 2011 2011 2011

[[4]]
[1] 2012 2012 2012

[[5]]
[1] 2013 2013 2013

[[6]]
[1] 2014 2014 2014

[[7]]
[1] 2015 2015 2015

[[8]]
[1] 2016 2016 2016

[[9]]
[1] 2017 2017 2017</code></pre>
<p>That’s almost right,
but <code>map</code> hasn’t flattened the list for us.
Luckily,
we can use <code>unlist</code> to do that:</p>
<pre class="sourceCode r"><code class="sourceCode r">years &lt;-<span class="st"> </span><span class="kw">map</span>(<span class="dv">2009</span><span class="op">:</span><span class="dv">2017</span>, rep, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()
years</code></pre>
<pre><code> [1] 2009 2009 2009 2010 2010 2010 2011 2011 2011 2012 2012 2012 2013 2013
[15] 2013 2014 2014 2014 2015 2015 2015 2016 2016 2016 2017 2017 2017</code></pre>
<p>We can now combine the years and kinds by pasting the two vectors together with <code>"-"</code> as a separator:</p>
<pre class="sourceCode r"><code class="sourceCode r">headers &lt;-<span class="st"> </span><span class="kw">paste</span>(years, kinds, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>)
headers</code></pre>
<pre><code> [1] &quot;2009-est&quot; &quot;2009-hi&quot;  &quot;2009-lo&quot;  &quot;2010-est&quot; &quot;2010-hi&quot;  &quot;2010-lo&quot; 
 [7] &quot;2011-est&quot; &quot;2011-hi&quot;  &quot;2011-lo&quot;  &quot;2012-est&quot; &quot;2012-hi&quot;  &quot;2012-lo&quot; 
[13] &quot;2013-est&quot; &quot;2013-hi&quot;  &quot;2013-lo&quot;  &quot;2014-est&quot; &quot;2014-hi&quot;  &quot;2014-lo&quot; 
[19] &quot;2015-est&quot; &quot;2015-hi&quot;  &quot;2015-lo&quot;  &quot;2016-est&quot; &quot;2016-hi&quot;  &quot;2016-lo&quot; 
[25] &quot;2017-est&quot; &quot;2017-hi&quot;  &quot;2017-lo&quot; </code></pre>
<p>Let’s use this to relabel the columns of <code>percents</code>
(which holds our data without the ISO country codes):</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(percents) &lt;-<span class="st"> </span>headers</code></pre>
<pre><code>Warning: The `names` must have length 28, not 27.
This warning is displayed once per session.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">percents</code></pre>
<pre><code># A tibble: 192 x 28
   `2009-est` `2009-hi` `2009-lo` `2010-est` `2010-hi` `2010-lo` `2011-est`
        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
 1         NA        NA        NA      NA        NA        NA         NA   
 2         NA        NA        NA      NA        NA        NA         NA   
 3         NA        NA        NA      NA        NA        NA          0.38
 4         NA        NA        NA       0.03      0.04      0.02       0.05
 5         NA        NA        NA      NA        NA        NA         NA   
 6         NA        NA        NA      NA        NA        NA         NA   
 7         NA        NA        NA      NA        NA        NA          0.13
 8         NA        NA        NA      NA        NA        NA         NA   
 9         NA        NA        NA      NA        NA        NA         NA   
10         NA        NA        NA      NA        NA        NA         NA   
# … with 182 more rows, and 21 more variables: `2011-hi` &lt;dbl&gt;,
#   `2011-lo` &lt;dbl&gt;, `2012-est` &lt;dbl&gt;, `2012-hi` &lt;dbl&gt;, `2012-lo` &lt;dbl&gt;,
#   `2013-est` &lt;dbl&gt;, `2013-hi` &lt;dbl&gt;, `2013-lo` &lt;dbl&gt;, `2014-est` &lt;dbl&gt;,
#   `2014-hi` &lt;dbl&gt;, `2014-lo` &lt;dbl&gt;, `2015-est` &lt;dbl&gt;, `2015-hi` &lt;dbl&gt;,
#   `2015-lo` &lt;dbl&gt;, `2016-est` &lt;dbl&gt;, `2016-hi` &lt;dbl&gt;, `2016-lo` &lt;dbl&gt;,
#   `2017-est` &lt;dbl&gt;, `2017-hi` &lt;dbl&gt;, `2017-lo` &lt;dbl&gt;, NA &lt;dbl&gt;</code></pre>
<p>Uh oh:
the warning message tells us that <code>percents</code> has the wrong number of columns.
Inspecting the tibble in the console,
we see that the last column is full of NAs,
which we can prove like this:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all</span>(<span class="kw">is.na</span>(percents[,<span class="kw">ncol</span>(percents)]))</code></pre>
<pre><code>[1] TRUE</code></pre>
<p>Let’s relabel our data again and then drop the empty column.
(There are other ways to do this, but I find steps easier to read after the fact this way.)</p>
<pre class="sourceCode r"><code class="sourceCode r">headers &lt;-<span class="st"> </span><span class="kw">c</span>(headers, <span class="st">&quot;empty&quot;</span>)
<span class="kw">names</span>(percents) &lt;-<span class="st"> </span>headers
percents &lt;-<span class="st"> </span><span class="kw">select</span>(percents, <span class="op">-</span>empty)
percents</code></pre>
<pre><code># A tibble: 192 x 27
   `2009-est` `2009-hi` `2009-lo` `2010-est` `2010-hi` `2010-lo` `2011-est`
        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
 1         NA        NA        NA      NA        NA        NA         NA   
 2         NA        NA        NA      NA        NA        NA         NA   
 3         NA        NA        NA      NA        NA        NA          0.38
 4         NA        NA        NA       0.03      0.04      0.02       0.05
 5         NA        NA        NA      NA        NA        NA         NA   
 6         NA        NA        NA      NA        NA        NA         NA   
 7         NA        NA        NA      NA        NA        NA          0.13
 8         NA        NA        NA      NA        NA        NA         NA   
 9         NA        NA        NA      NA        NA        NA         NA   
10         NA        NA        NA      NA        NA        NA         NA   
# … with 182 more rows, and 20 more variables: `2011-hi` &lt;dbl&gt;,
#   `2011-lo` &lt;dbl&gt;, `2012-est` &lt;dbl&gt;, `2012-hi` &lt;dbl&gt;, `2012-lo` &lt;dbl&gt;,
#   `2013-est` &lt;dbl&gt;, `2013-hi` &lt;dbl&gt;, `2013-lo` &lt;dbl&gt;, `2014-est` &lt;dbl&gt;,
#   `2014-hi` &lt;dbl&gt;, `2014-lo` &lt;dbl&gt;, `2015-est` &lt;dbl&gt;, `2015-hi` &lt;dbl&gt;,
#   `2015-lo` &lt;dbl&gt;, `2016-est` &lt;dbl&gt;, `2016-hi` &lt;dbl&gt;, `2016-lo` &lt;dbl&gt;,
#   `2017-est` &lt;dbl&gt;, `2017-hi` &lt;dbl&gt;, `2017-lo` &lt;dbl&gt;</code></pre>
<p>It’s time to put the country codes back on the table,
move the year and kind from column headers to a column with <code>gather</code>,
and then split that column with <code>separate</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">final &lt;-<span class="st"> </span>percents <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> countries) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">&quot;year_kind&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;value&quot;</span>, <span class="op">-</span>country) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">separate</span>(year_kind, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>))
final</code></pre>
<pre><code># A tibble: 5,184 x 4
   country year  kind  value
   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
 1 AFG     2009  est      NA
 2 ALB     2009  est      NA
 3 DZA     2009  est      NA
 4 AGO     2009  est      NA
 5 AIA     2009  est      NA
 6 ATG     2009  est      NA
 7 ARG     2009  est      NA
 8 ARM     2009  est      NA
 9 AUS     2009  est      NA
10 AUT     2009  est      NA
# … with 5,174 more rows</code></pre>
<p>Here’s everything in one function:</p>
<pre class="sourceCode r"><code class="sourceCode r">clean_infant_hiv &lt;-<span class="st"> </span><span class="cf">function</span>(filename, num_rows) {
  <span class="co"># Read raw data.</span>
  raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(filename, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span>num_rows)
  
  <span class="co"># Save the country names to reattach later.</span>
  countries &lt;-<span class="st"> </span>raw<span class="op">$</span>ISO3
  
  <span class="co"># Convert data values to percentages.</span>
  percents &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span>num_rows) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map_dfr</span>(str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">map_dfr</span>(<span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)

  <span class="co"># Change the headers on the percentages.</span>
  num_years &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2017</span> <span class="op">-</span><span class="st"> </span><span class="dv">2009</span>
  kinds &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;est&quot;</span>, <span class="st">&quot;hi&quot;</span>, <span class="st">&quot;lo&quot;</span>), num_years)
  years &lt;-<span class="st"> </span><span class="kw">map</span>(<span class="dv">2009</span><span class="op">:</span><span class="dv">2017</span>, rep, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()
  headers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste</span>(years, kinds, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>), <span class="st">&quot;empty&quot;</span>)
  <span class="kw">names</span>(percents) &lt;-<span class="st"> </span>headers
  
  <span class="co"># Stitch everything back together.</span>
  percents <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">country =</span> countries) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> <span class="st">&quot;year_kind&quot;</span>, <span class="dt">value =</span> <span class="st">&quot;value&quot;</span>, <span class="op">-</span>country) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">separate</span>(year_kind, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>))
}
<span class="kw">clean_infant_hiv</span>(<span class="st">&quot;raw/infant_hiv.csv&quot;</span>, <span class="dv">192</span>)</code></pre>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt;
&#39;Estimate_1&#39; [6], &#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt;
&#39;Estimate_2&#39; [9], &#39;hi&#39; =&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt;
&#39;Estimate_3&#39; [12], &#39;hi&#39; =&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt;
&#39;Estimate_4&#39; [15], &#39;hi&#39; =&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt;
&#39;Estimate_5&#39; [18], &#39;hi&#39; =&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt;
&#39;Estimate_6&#39; [21], &#39;hi&#39; =&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt;
&#39;Estimate_7&#39; [24], &#39;hi&#39; =&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt;
&#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt; &#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre><code>Warning: Expected 2 pieces. Missing pieces filled with `NA` in 192 rows
[5185, 5186, 5187, 5188, 5189, 5190, 5191, 5192, 5193, 5194, 5195, 5196,
5197, 5198, 5199, 5200, 5201, 5202, 5203, 5204, ...].</code></pre>
<pre><code># A tibble: 5,376 x 4
   country year  kind  value
   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
 1 AFG     2009  est      NA
 2 ALB     2009  est      NA
 3 DZA     2009  est      NA
 4 AGO     2009  est      NA
 5 AIA     2009  est      NA
 6 ATG     2009  est      NA
 7 ARG     2009  est      NA
 8 ARM     2009  est      NA
 9 AUS     2009  est      NA
10 AUT     2009  est      NA
# … with 5,366 more rows</code></pre>
<p>We’re done,
and we have learned a lot of R,
but what we have also learned is that we make mistakes,
and that those mistakes can easily slip past us.
If people are going to use our cleaned-up data in their analyses,
we need a better way to develop and check our scripts.</p>
</div>
<div id="key-points-4" class="section level2">
<h2><span class="header-section-number">6.5</span> Key Points</h2>
<ul>
<li>Develop data-cleaning scripts one step at a time, checking intermediate results carefully.</li>
<li>Use <code>read_csv</code> to read CSV-formatted tabular data into a tibble.</li>
<li>Use the <code>skip</code> and <code>na</code> parameters of <code>read_csv</code> to skip rows and interpret certain values as <code>NA</code>.</li>
<li>Use <code>str_replace</code> to replace portions of strings that match patterns with new strings.</li>
<li>Use <code>is.numeric</code> to test if a value is a number and <code>as.numeric</code> to convert it to a number.</li>
<li>Use <code>map</code> to apply a function to every element of a vector in turn.</li>
<li>Use <code>map_dfc</code> and <code>map_dfr</code> to map functions across the columns and rows of a tibble.</li>
<li>Pre-allocate storage in a list for each result from a loop and fill it in rather than repeatedly extending the list.</li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="tidyverse.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="testerror.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/gvwilson/tidynomicon/edit/master/cleanup.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": ["tidynomicon.pdf", "tidynomicon.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
